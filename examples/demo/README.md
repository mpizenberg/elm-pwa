# Progressive Web App with Elm

This example demonstrates how to build a PWA with Elm using the
[elm-pwa](elm-pwa/) package for service worker lifecycle, install prompt handling,
and online/offline detection.

## How it works

All PWA browser APIs are connected to Elm through two ports (`pwaIn` / `pwaOut`)
using a tagged JSON protocol. The [elm-pwa](elm-pwa/) package provides:

- **Elm module** (`Pwa`): event types, decoder, and command helpers
- **JS module** (`init`): wires browser events to the ports
- **Build function** (`generateSW`): produces a configurable service worker

The app defines two ports and delegates all PWA logic to the package:

```elm
port pwaIn : (Decode.Value -> msg) -> Sub msg
port pwaOut : Encode.Value -> Cmd msg

subscriptions _ =
    pwaIn (Pwa.decodeEvent >> GotPwaEvent)
```

### Service worker

Generated by `build-sw.mjs` using the package's `generateSW` function.
The generated `sw.js` uses cache-first for static assets, serves
the cached app shell for all navigation requests (Elm handles routing),
and supports `networkFirstPrefixes` / `networkOnlyPrefixes` for API routes.

Bump `cacheName` in `build-sw.mjs` on each deploy to trigger the update flow.

### Update flow

1. New SW installs in the background
2. JS detects it and sends `UpdateAvailable` through `pwaIn`
3. Elm shows an update banner
4. User clicks "Update now", Elm sends `acceptUpdate` through `pwaOut`
5. JS tells the waiting SW to `skipWaiting`
6. `controllerchange` fires and the page reloads

## Running the example

```sh
npm install
elm make src/Main.elm --output=static/elm.js
npx esbuild src/index.js --bundle --outfile=static/main.js
node build-sw.mjs
```

Then serve the `static/` directory:

```sh
cd static
python -m http.server 8000
```

Open `http://localhost:8000`.

To test offline: DevTools > Application > Service Workers > check "Offline".

To test install: use Chrome/Edge via `localhost` or HTTPS.

## Testing push notifications

Push notifications require a server to store subscriptions and send messages.
The demo is configured to use a [go-notify-server](https://github.com/mpizenberg/go-notify-server)
instance at `https://push.dokploy.zidev.ovh`.

### Prerequisites

- **Chrome** (or Chromium-based browser) — Firefox works too but setup differs
- **macOS**: System Settings > Notifications > Google Chrome must be enabled
- The service worker must have a `push` event handler — if you previously ran the
  demo before push support was added, **unregister the old service worker** in
  DevTools > Application > Service Workers, then reload

### Subscribe

1. Serve the demo (`cd static && python -m http.server 8000`)
2. Open `http://localhost:8000`
3. In the "Push Notifications" section, click **Enable Notifications** and accept the browser prompt
4. Click **Subscribe to Push** — the subscription is automatically registered with the push server

### Send a test notification

Once subscribed, the app shows a "Send Test Notification" form with title and body
fields. This uses the push server's unauthenticated topic API
(`POST /topics/{topic}/notify`) to let each device send a notification to itself
without needing admin credentials.

Each device gets a random topic (UUID) stored in `localStorage`. This topic is
sent to the server alongside the push subscription during registration, so the
server knows which subscriptions belong to which topic. The notify endpoint then
fans out to all subscriptions registered under that topic — in practice just the
current device.

Fill in a title and body, click **Send**, and a system notification should appear.
Clicking it updates "Last Notification Click" in the app.

You can also trigger it from the command line:

```sh
# The topic is stored in localStorage("pushTopic") — copy it from DevTools > Application > Local Storage
curl -X POST https://push.dokploy.zidev.ovh/topics/YOUR_TOPIC_UUID/notify \
  -H "Content-Type: application/json" \
  -d '{"title": "Hello!", "body": "Push from go-notify-server"}'
```

To broadcast to **all** subscriptions (requires admin auth):

```sh
curl -X POST https://push.dokploy.zidev.ovh/notify \
  -H "Authorization: Bearer YOUR_ADMIN_KEY" \
  -H "Content-Type: application/json" \
  -d '{"title": "Hello!", "body": "Push from go-notify-server", "url": "/test"}'
```

### Troubleshooting

- **No notification appears** — check macOS System Settings > Notifications > Chrome is enabled, then restart Chrome
- **"Registration failed - push service error"** — the active service worker is outdated (no push handler). Unregister it in DevTools > Application > Service Workers, then reload
- **Subscribe button does nothing** — the service worker hasn't finished registering yet. Wait a moment and retry, or check DevTools Console for errors

## Project structure

```
pwa/
  elm-pwa/                      -- reusable PWA package
    elm.json                    -- package type, exposes Pwa module
    package.json                -- npm package, exports init + generateSW
    src/Pwa.elm                 -- Event types, decoder, command helpers
    js/src/
      index.js                  -- init(): browser event wiring
      build.js                  -- generateSW(): SW code generation
  elm.json                      -- app, source-directories includes elm-pwa/src
  package.json                  -- esbuild dev dependency
  build-sw.mjs                  -- generates static/sw.js from config
  src/
    Main.elm                    -- Elm app using Pwa module
    index.js                    -- JS entry: Elm init + PWA init
  static/
    index.html                  -- loads elm.js + main.js
    manifest.webmanifest        -- web app manifest
    style.css                   -- app styles
    elm.js                      -- compiled Elm (generated)
    main.js                     -- bundled JS (generated)
    sw.js                       -- service worker (generated)
    icons/
      icon-192.png
      icon-512.png
```
